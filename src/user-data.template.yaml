#cloud-config

hostname: rpi5

locale: POSIX
timezone: UTC

users:
  - name: rpi5
    groups:
      - sudo
    shell: /bin/bash
    sudo:
      - 'ALL=(ALL) NOPASSWD:ALL'
    ssh_authorized_keys:
      - '$SSH_PUBLIC_KEY'

ssh_pwauth: false

write_files:
  - path: /etc/samba/smb.conf
    content: |
      [global]
      workgroup = WORKGROUP
      server string = Samba Server

      veto files = /.DS_Store/
      delete veto files = yes

      security = user
      map to guest = Bad User
      guest account = nobody

      min protocol = SMB2
      ea support = yes

      # https://wiki.samba.org/index.php/Configure_Samba_to_Work_Better_with_Mac_OS_X
      vfs objects = fruit streams_xattr
      fruit:metadata = stream
      fruit:model = MacSamba
      fruit:veto_appledouble = no
      fruit:zero_file_id = yes
      fruit:wipe_intentionally_left_blank_rfork = yes
      fruit:delete_empty_adfiles = yes
      fruit:posix_rename = yes
      fruit:nfs_aces = no

      load printers = no
      printing = bsd
      printcap name = /dev/null
      disable spoolss = yes

      [share]
      path = /mnt/pool2
      browseable = yes
      read only = no
      guest ok = yes
      guest only = yes
      force user = nobody
      force group = nogroup
      create mask = 0664
      directory mask = 0775

  - path: /etc/avahi/services/samba.service
    content: |
      <?xml version="1.0" standalone='no'?>
      <!DOCTYPE service-group SYSTEM "avahi-service.dtd">
      <service-group>
        <name replace-wildcards="yes">%h</name>
        <service>
          <type>_smb._tcp</type>
          <port>445</port>
        </service>
      </service-group>

runcmd:
  - ufw default deny incoming
  - ufw default allow outgoing
  - ufw allow from 192.168.1.0/24 to any port ssh
  - ufw allow from 192.168.1.0/24 to any port 445 proto tcp
  - ufw --force enable
  - apt-get update
  - apt-get upgrade --assume-yes
  - apt-get install --assume-yes zfsutils-linux
  - apt-get install --assume-yes nvme-cli
  - systemctl daemon-reload
  - systemctl start zfs-import-cache.service
  - zpool import -f pool1 && chown rpi5:rpi5 /mnt/pool1
  - zpool import -f pool2 && chown nobody:nogroup /mnt/pool2 && chmod 0775 /mnt/pool2
  - DEBIAN_FRONTEND=noninteractive apt-get install --assume-yes samba
  - systemctl disable --now nmbd
  - systemctl restart smbd
  - apt-get install --assume-yes avahi-daemon
  - systemctl enable --now avahi-daemon
  - reboot

bootcmd:
  - mount --options remount,noatime /
